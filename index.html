<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa Electoral</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script>
  <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet-search@2.9.8/dist/leaflet-search.min.css"
/>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .info.legend {
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // Crear el mapa
    const map = L.map('map').setView([-32.95, -60.65], 8); // Rosario como ejemplo

    // Capa base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Asignar colores seg√∫n el ganador
    function colorPorGanador(ganador) {
      switch (ganador) {
        case 'AGUST√çN ANDRES PELLEGRINI': return '#613583';
        case 'CAREN ESTEFANIA TEPP': return '#4c87e5';
        case 'GISELA SCAGLIA': return '#e66100';
        case 'OTROS': return '#9e9e9e';
        default: return '#cccccc';
      }
    }

    // Escalar transparencia seg√∫n participaci√≥n (de 0.3 a 1)
    function opacidadPorComodidad(p) {
      if (!p) return 0.5;
      let val = parseFloat(p.toString().replace(',', '.')); // por si viene como "0,65"
      //val = Math.min(Math.max(val, 0), 1); // limitar entre 0 y 1
      return 0.2 + 1 * val;
    }

    function getPopupContent(props) {
        const candidatos = [
            { nombre: "Fuerza Patria", color: "üü¶", porcentaje: parseFloat(props["FUERZA PATRIA"]) },
            { nombre: "La Libertad Avanza", color: "üü™", porcentaje: parseFloat(props["LA LIBERTAD AVANZA"]) },
            { nombre: "Provincias Unidas", color: "üüß", porcentaje: parseFloat(props["PROVINCIAS UNIDAS"]) },
        ];

        candidatos.sort((a, b) => b.porcentaje - a.porcentaje);

        return candidatos.map(c => 
            `<div>${c.color} ${c.nombre}: ${c.porcentaje.toFixed(1)}%</div>`
        ).join("");
    }

    let selectedLayer = null;

    function style(feature) {
      return {
        color: "black",
        weight: 1,
        fillColor: "#cccccc",
        fillOpacity: 0.7
      }
    }

    // Cargar GeoJSON exportado desde QGIS
    fetch('mapa_resultados.geojson')
      .then(res => res.json())
      .then(data => {
        const Layer = L.geoJSON(data, {
          style: feature => ({
            color: '#000', // borde negro
            weight: 0.5,
            fillColor: colorPorGanador(feature.properties.ganador),
            fillOpacity: opacidadPorComodidad(feature.properties.comodidad_n)
          }),
          onEachFeature: (feature, layer) => {
            layer.bindPopup(`
              <b>Circuito: ${feature.properties.circuito_n}</b><br>
              Localidad: ${feature.properties.cabecera}<br>
              Electores Totales: ${feature.properties.electores_n}<br>
              Participaci√≥n: ${parseFloat(feature.properties.participacion_n).toFixed(2)}%<br><br>
              ${getPopupContent(feature.properties)}
            `);

            layer.on("click", () => {
              if(selectedLayer && selectedLayer !== layer) {
                selectedLayer.setStyle({weight: 0.5, color: "#000"})
              }
              layer.setStyle({weight: 5, color: "#e01b24"})
              selectedLayer = layer
            })
          }
        }).addTo(map);

        const legend = L.control({ position: "topright" });

        legend.onAdd = function (map) {
          const div = L.DomUtil.create("div", "info legend");
          div.innerHTML = `
            <strong>Intensidad del color</strong><br>
            <div style="
              height:10px;
              width:120px;
              background:linear-gradient(to right,
                rgba(0,0,0,0.2),
                rgba(0,0,0,0.9)
              );
              margin-top:4px;">
            </div>
            <small>M√°s opaco ‚Üí mayor diferencia entre primero y segundo</small><br>
            <small>M√°s transparente ‚Üí elecci√≥n m√°s pareja</small>
          `;
          return div;
        };

        legend.addTo(map);

        map.on("click", (e) => {
          if(selectedLayer) {
            selectedLayer.setStyle({weight: 0.5, color: "#000"})
            selectedLayer = null
          }
        })

            // üîç Control de b√∫squeda
        const searchControl = new L.Control.Search({
          layer: Layer,
          propertyName: "cabecera", // por cu√°l campo buscar
          initial: false,
          zoom: 13,
          marker: false,
          textPlaceholder: "Buscar localidad"
        });

        searchControl.on("search:locationfound", function (e) {
          if (selectedLayer) {
            selectedLayer.setStyle({ weight: 1, color: "black" });
          }
          e.layer.openPopup();
          e.layer.setStyle({ weight: 3, color: "#ffcc00" });
          selectedLayer = e.layer;
        });

        map.addControl(searchControl);
      });
  </script>
</body>
</html>
